<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DELTA+</title>
    <style>
        @font-face {
            font-family: 'New Science';
            src: url('game/styles/NewScience-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'New Science';
            src: url('game/styles/NewScience-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            font-family: 'New Science', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
            background-color: #000;
            background-image: url('assets/web-bgs/web_bg.jpg');
            background-position: top center;
            background-repeat: no-repeat;
            background-size: auto;
            background-attachment: scroll;
            overflow-x: hidden;
        }

        /* Video sections - full viewport height */
        .video-section {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .video-section video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Floating island - centered on first section with higher z-index */
        .floating-island {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35%;
            max-width: 460px;
            z-index: 10;
            /* allow clicks on the island so it can enable audio */
            pointer-events: auto;
            cursor: pointer;
        }

        .floating-island video {
            display: block;
            width: 100%;
            height: auto;
            pointer-events: auto;
            cursor: pointer;
        }

        /* Video frame container - centered on section (for second section) */
        .video-frame-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            max-width: 700px;
            z-index: 10;
        }

        /* Content container for third section */
        .content-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            max-width: 700px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .content-container .video-frame-container {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            width: 100%;
        }

        /* Frame image as background */
        .video-frame {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            padding: calc(5% - 31px) calc(5% - 23px);
        }

        .video-frame img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        /* Video wrapper with rounded corners and overflow hidden */
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            overflow: hidden;
            z-index: 1;
        }

        /* YouTube iframe */
        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Local video element */
        .video-wrapper video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        /* Make the giant map clickable and show pointer */
        .map-link { display: block; width: 100%; text-decoration: none; color: inherit; }
        .map-link .video-wrapper { cursor: pointer; }

        /* News section below video frame */
        .news-section {
            width: 100%;
        }

        .news-line {
            width: 100%;
            display: block;
            margin-top: 0px;
            margin-bottom: 20px;
        }

        /* News items row */
        .news-items {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: none;
        }

        .news-items::-webkit-scrollbar {
            display: none;
        }

        .news-item {
            flex: 0 0 auto;
            position: relative;
            background-image: url('assets/ui/oblea1.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 240px;
            height: 238px;
            padding: 28px 22px;
            color: #DDDC31;
            font-family: 'New Science', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .news-item h3 {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: bold;
            color: #DDDC31;
            text-transform: uppercase;
        }

        .news-item p {
            margin: 0;
            font-size: 14px;
            color: #DDDC31;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Jugar button */
        .jugar-button {
            position: absolute;
            bottom: 12%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            padding: 12px 40px;
            font-size: 24px;
            font-weight: bold;
            font-family: 'New Science', sans-serif;
            color: #000;
            background: linear-gradient(135deg, #DDDC31 0%, #FFE55C 100%);
            border: 3px solid #fff;
            border-radius: 40px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            pointer-events: auto;
        }

        .jugar-button:hover {
            transform: translateX(-50%) translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
            background: linear-gradient(135deg, #FFE55C 0%, #DDDC31 100%);
        }

        .jugar-button:active {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.6);
        }
        /* Footer styles */
        .site-footer {
            width: 100%;
            padding: 28px 18px;
            box-sizing: border-box;
            text-align: center;
            color: #FFF;
            font-family: 'New Science', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
            font-size: 14px;
            letter-spacing: 0.08em;
            background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.55));
            backdrop-filter: blur(4px);
        }

        .site-footer__inner {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.06);
        }

        /* PWA action buttons */
        .pwa-actions {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            margin-left: 12px;
        }

        .pwa-button {
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 700;
            color: #000;
            background: linear-gradient(135deg, #DDDC31 0%, #FFE55C 100%);
            border: 2px solid #fff;
            border-radius: 24px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }

        .pwa-button[hidden] { display: none; }

        /* Toast / progress UI */
        .pwa-toast {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            min-width: 280px;
            max-width: 90%;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 20000;
        }

        .pwa-toast[hidden] { display: none; }

        .pwa-progress {
            flex: 1 1 auto;
            height: 10px;
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            overflow: hidden;
        }

        .pwa-progress > .bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg,#DDDC31,#FFE55C);
            transition: width 260ms linear;
        }

        .pwa-toast .label { font-size: 13px; white-space: nowrap; }

        .site-footer__inner strong {
            display: inline-block;
            font-weight: 700;
            color: #FFE55C;
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <!-- First video section with floating island (background video removed to show body image) -->
    <section class="video-section">
        <!-- Floating island centered on top -->
        <div class="floating-island">
            <video autoplay loop muted playsinline>
                <source src="assets/island.webm" type="video/webm">
            </video>
        </div>

        <!-- 'Jugar' button removed from landing (kept in-game menu link removed) -->
    </section>

    <!-- Second video section with framed YouTube video (background video removed to show body image) -->
    <section class="video-section">
        <!-- Video frame container -->
        <div class="video-frame-container">
            <div class="video-frame">
                <div class="video-wrapper">
                    <iframe 
                        src="https://www.youtube.com/embed/ANyR_fuIF-g?rel=0&modestbranding=1&playsinline=1"
                        title="Video"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen>
                    </iframe>
                </div>
                <img src="assets/ui/marco_videos_web.png" alt="">
            </div>
        </div>
    </section>

    <!-- Third video section with framed local video (background video removed to show body image) -->
    <section class="video-section">
        <!-- Content container with video and news -->
        <div class="content-container">
            <!-- Video frame container -->
            <div class="video-frame-container">
                <a href="game/index.html#menu" class="map-link" aria-label="Ir al juego">
                <div class="video-frame">
                    <div class="video-wrapper">
                        <video autoplay loop muted playsinline>
                            <source src="assets/mapa_gigante.webm" type="video/webm">
                        </video>
                    </div>
                    <img src="assets/ui/marco_videos_web.png" alt="">
                </div>
                </a>
            </div>

            <!-- News section -->
            <div class="news-section">
                <img src="assets/ui/linea news.png" alt="" class="news-line">
                <div class="news-items">
                    <div class="news-item">
                        <h3>Contenidos para el aula</h3>
                        <p>Entrá acá para descargar fichas, manuales, guías y consejos.</p>
                    </div>
                    <div class="news-item">
                        <h3>Historias de vida</h3>
                        <p>Conocé a las personas detrás del Delta.</p>
                    </div>
                    <div class="news-item">
                        <h3>Material extra</h3>
                        <p>Informate más.</p>
                    </div>  
                </div>
            </div>
        </div>
    </section>
    
    <!-- Site footer -->
    <footer class="site-footer" aria-label="Pie de página">
        <div class="site-footer__inner">
            <strong>© Delta Grande 2025</strong> Todos los derechos reservados
            <span class="pwa-actions" aria-hidden="false">
                <button id="pwaInstallBtn" class="pwa-button" hidden aria-label="Instalar aplicación">Instalar</button>
                <button id="pwaSaveBtn" class="pwa-button" aria-label="Guardar para uso offline">Guardar offline</button>
                    <button id="enable-audio-global" class="pwa-button" aria-label="Habilitar audio">Habilitar audio</button>
            </span>
        </div>
    </footer>
    
    <script>
        // Basic PWA install + offline helpers
        (function(){
            let deferredPrompt = null;
            const installBtn = document.getElementById('pwaInstallBtn');
            const saveBtn = document.getElementById('pwaSaveBtn');

            // Listen for the beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                deferredPrompt = e;
                // Show the install button
                if (installBtn) installBtn.hidden = false;
            });

            // Register service worker (if available)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js').then((reg) => {
                    console.log('ServiceWorker registrado:', reg);
                }).catch((err) => {
                    console.warn('ServiceWorker registro fallido:', err);
                });
            }

            // Install button action
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const choice = await deferredPrompt.userChoice;
                    if (choice && choice.outcome) {
                        console.log('Install choice:', choice.outcome);
                    }
                    // Hide the install button after attempt
                    deferredPrompt = null;
                    installBtn.hidden = true;
                });
            }

            // Save offline action: send a message to the service worker to cache resources
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    if (!('serviceWorker' in navigator)) {
                        alert('Service Worker no soportado en este navegador.');
                        return;
                    }

                    try {
                        const reg = await navigator.serviceWorker.ready;
                        if (reg && reg.active) {
                            // Show toast UI and kick off caching
                            showPwaToast('Guardando recursos...', 0);
                            reg.active.postMessage({ type: 'CACHE_OFFLINE' });
                            // The service worker will post progress messages back
                        } else {
                            alert('Service Worker aún no está activo. Intenta de nuevo en unos segundos.');
                        }
                    } catch (err) {
                        console.warn('Error al pedir cache offline:', err);
                        alert('No se pudo iniciar el guardado offline.');
                    }
                });
            }

            // When the app is installed, hide install button
            window.addEventListener('appinstalled', () => {
                if (installBtn) installBtn.hidden = true;
                console.log('App instalada');
            });
        })();
    </script>

    <!-- PWA progress toast -->
    <div id="pwaToast" class="pwa-toast" hidden role="status" aria-live="polite">
        <div class="label">Guardando para uso offline...</div>
        <div class="pwa-progress" aria-hidden="true"><div class="bar"></div></div>
        <div id="pwaToastPct" class="label">0%</div>
    </div>

    <!-- Simple global audio element used to play web_musica.ogg -->
    <audio id="web-music" preload="auto"></audio>

    <script type="module">
        const enableBtn = document.getElementById('enable-audio-global');
        const audioEl = document.getElementById('web-music');
        const islandEl = document.querySelector('.floating-island');

        // Preload background music and SFX to avoid playback delay on first click
        const PRELOAD_BG_SRC = '/assets/web_musica.ogg';
        const PRELOAD_SFX_SRC = '/assets/exito.mp3';

        // Prepare SFX element and preload it
        const sfxEl = new Audio(PRELOAD_SFX_SRC);
        sfxEl.preload = 'auto';
        sfxEl.crossOrigin = 'anonymous';
        // Lower SFX volume to be less intrusive
        sfxEl.volume = 0.1;
        // Trigger load to warm cache (won't autoplay)
        try { sfxEl.load(); } catch (e) { /* ignore load errors */ }

        // Configure background audio element for preloading (don't play yet)
        if (audioEl) {
            audioEl.src = PRELOAD_BG_SRC;
            audioEl.loop = true;
            audioEl.volume = 0.4; // restored background volume (only SFX lowered)
            audioEl.crossOrigin = 'anonymous';
            audioEl.preload = 'auto';
            try { audioEl.load(); } catch (e) { /* ignore load errors */ }
        }

        async function enableGlobalAudio() {
            if (!audioEl) return;
            if (audioEl.dataset.enabled === '1') return; // already enabled

            // Debugging listeners (idempotent-ish)
            audioEl.addEventListener('canplaythrough', () => console.log('[Audio] canplaythrough'));
            audioEl.addEventListener('loadeddata', () => console.log('[Audio] loadeddata'));
            audioEl.addEventListener('playing', () => console.log('[Audio] playing'));
            audioEl.addEventListener('play', () => console.log('[Audio] play event fired'));
            audioEl.addEventListener('error', (ev) => console.error('[Audio] error', ev, audioEl.error));

            try {
                await audioEl.play();
                audioEl.dataset.enabled = '1';
                if (enableBtn) {
                    enableBtn.textContent = 'Audio habilitado';
                    enableBtn.disabled = true;
                }
                console.log('[Audio] reproducción iniciada con elemento <audio>');
            } catch (playErr) {
                console.warn('[Audio] play() falló:', playErr);
                try {
                    const Ctx = window.AudioContext || window.webkitAudioContext;
                    if (Ctx) {
                        const ctx = new Ctx();
                        await ctx.resume();
                        // try again
                        await audioEl.play();
                        audioEl.dataset.enabled = '1';
                        if (enableBtn) {
                            enableBtn.textContent = 'Audio habilitado';
                            enableBtn.disabled = true;
                        }
                        console.log('[Audio] reproducción iniciada tras activar AudioContext');
                    }
                } catch (ctxErr) {
                    console.error('[Audio] No se pudo iniciar reproducción tras fallback:', ctxErr);
                }
            }
        }

        if (enableBtn) enableBtn.addEventListener('click', enableGlobalAudio);

        // Also enable audio when the user clicks the floating island (first section)
        if (islandEl) {
            islandEl.addEventListener('click', async (ev) => {
                try {
                    await enableGlobalAudio();

                    // Play preloaded success SFX once on island click
                    try {
                        if (sfxEl) {
                            // restart from start
                            try { sfxEl.currentTime = 0; } catch (e) { /* ignore */ }
                            sfxEl.play().catch((err) => console.warn('[SFX] play error', err));
                        } else {
                            // fallback to dynamic Audio if needed
                            const fallback = new Audio(PRELOAD_SFX_SRC);
                            fallback.volume = 0.9;
                            fallback.crossOrigin = 'anonymous';
                            fallback.play().catch(() => {});
                        }
                    } catch (sfxErr) {
                        console.warn('No se pudo reproducir SFX de exito:', sfxErr);
                    }

                    // Optional: give visual feedback on click by briefly toggling a class
                    islandEl.classList.add('clicked-audio');
                    setTimeout(() => islandEl.classList.remove('clicked-audio'), 600);
                } catch (e) {
                    console.warn('Error al manejar click en la isla:', e);
                }
            });
        }
    </script>

    <script>
        // Handle messages from service worker to update progress UI
        (function(){
            const toast = document.getElementById('pwaToast');
            const bar = toast ? toast.querySelector('.pwa-progress > .bar') : null;
            const pct = document.getElementById('pwaToastPct');

            function showPwaToast(message, percent) {
                if (!toast) return;
                toast.querySelector('.label').textContent = message;
                if (bar) bar.style.width = (percent || 0) + '%';
                if (pct) pct.textContent = Math.round(percent || 0) + '%';
                toast.hidden = false;
            }

            function hidePwaToast() {
                if (!toast) return;
                toast.hidden = true;
            }

            // Expose a show function used by the other inline script
            window.showPwaToast = showPwaToast;

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    const data = event.data || {};
                    if (data.type === 'CACHE_PROGRESS') {
                        const { cached, total, url } = data;
                        const pctVal = total ? Math.round((cached / total) * 100) : 0;
                        showPwaToast(`Guardando recursos... (${cached}/${total})`, pctVal);
                    } else if (data.type === 'CACHE_ERROR') {
                        // show an error briefly
                        showPwaToast('Error guardando recursos: ' + (data.url || ''), 0);
                        setTimeout(hidePwaToast, 4000);
                    } else if (data.type === 'CACHE_COMPLETE') {
                        const { cached, total } = data;
                        showPwaToast(`Listo: ${cached}/${total} recursos guardados`, 100);
                        setTimeout(hidePwaToast, 3000);
                    }
                });
            }
        })();
    </script>

</body>

</html>