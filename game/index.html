<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DELTA+ — Juego</title>
  <link rel="stylesheet" href="https://use.typekit.net/tas7aat.css">
  <style>
    :root {
      --bg: #0d0f12;
      --fg: #eef2f6;
      --muted: #94a3b8;
      --accent: #35c9a5;
      --card: #141820;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      overflow: hidden;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="6" fill="white" stroke="rgba(255,255,255,0.5)" stroke-width="2"/></svg>') 10 10, auto;
    }

    #app {
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
    }

    /* UI overlay */
    .hud {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .topbar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      pointer-events: auto;
    }

    .pill {
      background: #0009;
      border: 1px solid #ffffff22;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 14px;
    }

    .btn {
      background: #1a2230;
      border: 1px solid #2a3547;
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--fg);
    }

    .btn:hover {
      background: #1d2736
    }

    .panel {
      position: absolute;
      right: 12px;
      top: 50px;
      width: 280px;
      max-height: 648px;
      overflow: auto;
      background: var(--card);
      border: 1px solid #1f2732;
      border-radius: 12px;
      padding: 12px;
      pointer-events: auto;
      z-index: 200000;
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 16px
    }

    .panel ul {
      margin: 0;
      padding-left: 16px
    }

    .panel li {
      margin: 4px 0;
      color: var(--muted)
    }

    .map-overlay {
      position: absolute;
      right: 0;
      bottom:6vh;
      width: 12vw;
      /* slightly smaller than previous (approx -15%) */
      height: 7.3vw;
      /* slightly smaller height to keep aspect ratio */
      pointer-events: none;
      z-index: 6000;
      display: none;
    }


    .metadata-overlay {
      position: absolute;
      left: 0;
      bottom: 6vh;
      width: 12vw;
      /* slightly smaller than previous (approx -15%) */
      height: 7.3vw;
      /* slightly smaller height to keep aspect ratio */
      pointer-events: none;
      z-index: 6000;
      display: none;
    }



    .metadata-overlay video {
      display: block;
      width: 100%;
      height: auto;
      max-width: none;
    }

    /* Lock overlays size when viewport is wider than 16:9 */
    @media (min-aspect-ratio: 16/9) {
      /* Removed fixed overlay breakpoints for map/metadata so they
         remain responsive (use the vw-based sizing defined above). */
      #zocaloVideo {
        width: 300px;
        /* Fixed size - same as original */
        height: 200px;
      }

    }


    .map-overlay__inner {
      position: relative;
      width: 100%;
      height: 100%;
      mask-image: url('../game-assets/recorrido/paneles/panel%20mapa.png');
      -webkit-mask-image: url('../game-assets/recorrido/paneles/panel%20mapa.png');
      mask-repeat: no-repeat;
      -webkit-mask-repeat: no-repeat;
      mask-size: 100% 100%;
      -webkit-mask-size: 100% 100%;
      mask-position: center;
      -webkit-mask-position: center;
      overflow: hidden;
      pointer-events: none;
    }

    .map-overlay__map {
      position: absolute;
      z-index: 4500;
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      transform-origin: center center;
    }

    .map-overlay__frame {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: none;
      object-fit: fill;
      z-index: 1;
    }

    /* FULLSCREEN video overlay (sin controles visibles) */
    .video-overlay {
      position: fixed;
      inset: 0;
      display: none;
      background: transparent;
      /* permitir que se vea el 3D debajo con alpha del video */
      z-index: 9999;
      pointer-events: auto;
    }

    .video-overlay video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* pantalla completa */
      display: block;
      background: transparent;
      /* asegurar que las zonas alfa se vean transparentes */
    }

    /* Zócalo de escena - video arriba a la izquierda */
    #zocaloVideo {
      position: absolute;
      top: 40px;

      left: 0;
      width: 24vw;
      height: auto;
      pointer-events: none;
      z-index: 5000;
      object-fit: contain;
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }

    #hudCanvas {
      position: absolute;
      inset: 0;
      z-index: 3000;
      /* sobre tu three.js canvas */
      pointer-events: none;
    }

    @font-face {
      font-family: 'OCRMono';
      src: local('OCR A Std'), local('OCR A'), local('Courier New');
    }

    .threelabel {
      font-family: OCRMono, ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
      color: #fff;
      font-size: 12px;
      letter-spacing: 0.02em;
    }

    /* Legacy canvas fallback (kept for compatibility) */
    #inventoryCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      /* scale with window */
      height: 100%;
      pointer-events: none;
    }

    /* Inventory panel: full-screen 16:9 element that always covers the viewport.
       The parent is a fixed, overflow-hidden container; the inner box preserves
       a 16:9 ratio and is sized so one dimension always >= viewport, producing
       a cover effect while maintaining aspect ratio. Pointer events are disabled. */
    #inventoryPanel {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 4000;
      pointer-events: none;
      overflow: hidden;
      background: transparent;
    }

    #inventoryPanel .inventory-inner {
      position: absolute;
      left: 50%;
      bottom: 0; /* anchor to bottom of viewport */
      transform: translateX(-50%); /* center horizontally only */
      /* default sizing: make inner preserve 16:9 and cover viewport */
      width: calc(100vh * 16 / 9);
      height: 100vh;
      pointer-events: none;
    }

    #inventoryPanel img#inventoryImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      pointer-events: none;
      user-select: none;
    }

    /* For tall/narrow viewports (mobile portrait), switch sizing so width fills the viewport */
    @media (max-aspect-ratio: 16/9) {
      #inventoryPanel .inventory-inner {
        width: 100vw;
        height: calc(100vw * 9 / 16);
        bottom: 0; /* keep anchored to bottom on narrow viewports too */
      }
    }

  

    /* Fullscreen-fit 16:9 wrapper that acts as the root for the textbox.
         It will always fit inside the viewport while preserving 16:9. */
    .efedra-wrapper {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(100vw, calc(100vh * 16 / 9));
      height: min(100vh, calc(100vw * 9 / 16));
      aspect-ratio: 16 / 9;
      max-width: 100%;
      max-height: 100%;
      z-index: 10002;
      pointer-events: none;
      /* wrapper itself should not capture clicks */
      overflow: visible;
      box-sizing: border-box;
      display: block;
    }

    /* The textbox is positioned absolutely inside the wrapper so coordinates
         like left/top are relative to the 16:9 root. */
    #efedra-text-overlay {
      position: absolute;
      left: 62.5%;
      top: 17.1%;
      width: 18%;
      /* Limit the visual height of the box so content beyond this is hidden
         and can be scrolled. We set a fixed max-height relative to the 16:9
         wrapper and ensure overflow-y provides scrolling. */
      max-height: 27%;
      overflow-y: auto;
      overflow-x: hidden;
      /* allow the overlay to receive pointer/touch events so it can scroll */
      pointer-events: auto;
      touch-action: auto;
      z-index: 10003;
      /* Keep a reasonable fallback for small viewports */
      height: auto;
      box-sizing: border-box;
      padding: 8px;
      background: linear-gradient(180deg, rgba(0,0,0,0.06), transparent);
      -webkit-overflow-scrolling: touch;
    }
    
    #speciesDataVideo {
      width: 100%;
    }
    /* When viewport is wider than 16:9, constrain the inventory canvas
   to maintain 16:9 aspect ratio and center it horizontally */
    @media (min-aspect-ratio: 16/9) {
      #inventoryCanvas {
        width: calc(100vh * 16 / 9);
        height: 100vh;
        left: 50%;
        transform: translateX(-50%);
        top: 0;
        transform-origin: center;
        pointer-events: none;
      }
    }

    .menu-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999999999;
      pointer-events: auto;
      flex-direction: column;
      gap: 18px;
      font-family: "new-science", 'New Science', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }

    .menu-overlay.is-visible {
      display: flex;
    }

    .menu-overlay__title {
      font-size: 32px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .menu-overlay__options {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-width: 320px;
    }

    .menu-button {
      padding: 14px 18px;
      border: 1px solid #ffffff33;
      border-radius: 10px;
      background: rgba(28, 36, 46, 0.85);
      color: var(--fg);
      font-size: 18px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      font-family: inherit;
    }

    .menu-button:hover:not(:disabled),
    .menu-button:focus-visible:not(:disabled) {
      background: rgba(53, 201, 165, 0.35);
      transform: translateY(-2px);
      outline: none;
    }

    .menu-button:disabled {
      cursor: not-allowed;
      opacity: 0.4;
    }

    .menu-overlay--main {
      background: #000;
    }

    .menu-overlay--main .menu-overlay__title {
      font-size: 38px;
    }

    .menu-overlay__logo {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      max-width: 800px;
      height: auto;
      pointer-events: none;
    }
    /* Sequence overlay styling (centered square, no shadow/border)
       Kept here in the main stylesheet instead of inline on the element. */
    #sequenceOverlay {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 30vw;
      max-width: 30vw;
      /* Prevent scaling down once the viewport becomes narrower than 16:9:
         compute the equivalent width at a 16:9 breakpoint and use it as
         a minimum width so the element doesn't shrink below that. */
      min-width: calc(53.3333vh); /* = 0.3 * (16/9) * 100vh ≈ 53.3333vh */
      aspect-ratio: 1 / 1;
      pointer-events: none;
      z-index: 10001;
      display: none;
    }

    #sequenceOverlay video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: transparent;
    }
    /* Instructions overlay: keep video top-centered on wide viewports
       and ensure it always covers the viewport (no side bars). */
    .efedra-instrucciones-overlay video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      z-index: 10000;
    }
    @media (min-aspect-ratio: 16/9) {
      .efedra-instrucciones-overlay video {
        position: absolute;
        top: 0;
        left: 50%;
        height: 100% !important;
        width: auto !important;
        /* ensure width is at least full viewport so there are no black bars */
        min-width: 100% !important;
        /* also guard min-height so very wide viewports are covered */
        min-height: 100% !important;
        transform: translateX(-50%) !important;
        object-fit: cover !important;
        object-position: top center !important;
      }
    }
  </style>
  <style id="recorrido-transition-overlay-style">
    /* Styles for RecorridoTransitionScene text overlay (extracted from JS) */
    .recorrido-transition-text-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      /* limit width so the box isn't too wide on large viewports
        increased 50% from previous max (360px -> 540px) to make it wider */
      width: min(540px, 51vmin);
      max-width: 90vw;
      aspect-ratio: 1 / 1;
      z-index: 10003;
      pointer-events: none;
      text-align: center;
      /* Aumentado padding para dar más espacio alrededor del texto */
      padding: clamp(14px, 3.5vmin, 40px);
      opacity: 0;
      transition: opacity 1s ease-in;
      display: flex;
      align-items: center; /* center vertically */
      justify-content: center; /* center horizontally */
      box-sizing: border-box;
      font-family: "new-science-mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }

    .recorrido-transition-text-overlay[aria-hidden="false"] {
      opacity: 1;
    }

    .recorrido-transition-text-inner {
      /* Scale with the square overlay using vmin so text grows/shrinks with it.
         Increase max so text can scale UP on large overlay sizes. */
      font-size: clamp(12px, 2vmin, 28px);
      font-weight: 400;
      color: #FDFE63;
      text-shadow: 0 0 18px rgba(0,0,0,0.6);
      letter-spacing: 0.02em;
      line-height: 1.6;
      max-height: 100%;
      overflow: auto; /* allow scrolling when text is long */
      text-align: center; /* alinear texto al centro */
    }
  </style>
  <link rel="stylesheet" href="./styles/sub/deck-style.css">

  <!-- Efedra overlay font and styles (extracted from RecorridoScene.js) -->
  <link id="efedra-font-kit" rel="stylesheet" href="https://use.typekit.net/vmy8ypx.css">
  <!-- Kit para new-science (landing page font) usado en overlays -->
  <link rel="stylesheet" href="https://use.typekit.net/tas7aat.css">
  <style id="efedra-text-overlay-style">
    /* Efedra overlay styles (previously injected from JS) */
    #efedra-text-overlay {
      font-family: "new-science-mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color: #FFC96A;
      font-variant-numeric: tabular-nums lining-nums;
      text-transform: none;
      letter-spacing: 0.015em;
      scrollbar-width: thin;
      scrollbar-color: #FFC96A rgba(11, 18, 28, 0.45);
    }

    #efedra-text-overlay::-webkit-scrollbar {
      width: 12px;
      background: transparent;
    }

    #efedra-text-overlay::-webkit-scrollbar-track {
      background: rgba(11, 18, 28, 0.38);
      border-radius: 999px;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.45);
    }

    #efedra-text-overlay::-webkit-scrollbar-thumb {
      background: #FFC96A;
      border-radius: 999px;
      box-shadow: 0 0 18px rgba(255, 201, 106, 0.55);
      border: 2px solid rgba(14, 22, 33, 0.65);
    }

    #efedra-text-overlay::-webkit-scrollbar-thumb:hover {
      background: #ffe394;
    }
  </style>
  <style id="transition-text-overlay-style">
    /* Transition text overlay (moved from inline attributes) */
    #transition-text-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      /* Make overlay a responsive square that scales with viewport (vmin)
         while capping at a reasonable max width. This ensures text scales
         consistently with aspect ratio like other overlay boxes. */
      /* Make overlay larger but still responsive. Expose the chosen size as
         a CSS variable so child elements (like text) can base sizes off it. */
      --overlay-size: 45vmin;
      width: var(--overlay-size);
      aspect-ratio: 1 / 1;
      z-index: 10003;
      pointer-events: none;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 1s ease-in;
      box-sizing: border-box;
      /* Añadimos padding para separar el texto del borde del overlay */
      padding: clamp(14px, 3.5vmin, 40px);
      /* Use the new-science font used by Efedra overlay (fallback to system stack) */
      font-family: "new-science-mono", system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
    }

    /* When made visible by JS, it becomes a flex container */
    #transition-text-overlay[aria-hidden="false"] {
      display: flex;
    }

    .transition-text-inner {
      /* Scale font size with viewport (vmin) so it grows/shrinks with the
         square overlay. Clamp provides sensible min/max sizes. */
      /* Font scales with the overlay width: multiply the overlay size to
        compute a responsive mid value, clamped between min and max. This
        makes the font increase as the overlay grows but stops at a max. */
      font-size: clamp(10px, 2vmin, 32px);
      font-weight: 400;
      color: #FDFE63;
      text-shadow: 0 0 18px rgba(0,0,0,0.6);
      letter-spacing: 0.02em;
      line-height: 1.4;
      text-align: left;
      max-height: 100%;
      overflow: auto;
      box-sizing: border-box;
      /* inherit the same font from the overlay container (keeps consistency) */
      font-family: inherit;
    }

    /* Progress Overlay */
    .progress-overlay {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: min(21.4vw, 291px);
      height: auto;
      aspect-ratio: 544 / 232;
      z-index: 12000;
      pointer-events: none;
    }

    .progress-overlay .progress-bg {
      width: 100%;
      height: 100%;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
    }

    .progress-overlay .progress-full {
      width: 100%;
      height: 100%;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
    }

    .progress-bar-mask {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: clip-path 0.5s ease-out;
    }

    .progress-indicator {
      position: absolute;
      width: 12.132%; /* 66px / 544px */
      height: 17.672%; /* 41px / 232px */
      background: rgba(221, 220, 49, 1);
      border: 2px solid #212A4F;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translateY(-50%);
      transition: left 0.5s ease-out;
      left: 41.36%; /* 225px / 544px */
    }

    .progress-indicator .progress-percentage {
      font-family: "new-science", system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      font-size: clamp(12px, 1.4vw, 22px);
      font-weight: normal;
      color: #000;
      text-align: center;
    }
  </style>
  

  <script type="importmap">
{
"imports": {
"three": "https://unpkg.com/three@0.164.1/build/three.module.js",
"three/addons/": "https://unpkg.com/three@0.164.1/examples/jsm/"
}
}
</script>
</head>

<body>
  <div id="app">
    <canvas id="hudCanvas"></canvas>
    <!-- Inventory panel: replaced canvas with a responsive div+img for aspect-safe rendering -->
    <div id="inventoryPanel" aria-hidden="true">
      <div class="inventory-inner">
        <img id="inventoryImage" src="../game-assets/recorrido/paneles/paneles_entero.png" alt="Inventory panel" />
      </div>
    </div>

    <video id="hudVideo" src="../game-assets/recorrido/paneles/overlay mburucuya.mp4" playsinline muted loop
      style="display:none"></video>

    <div class="hud" id="hud">
      <div class="map-overlay" aria-hidden="true">
        <div class="map-overlay__inner">
          <img class="map-overlay__map" src="../game-assets/recorrido/mapa01.png" alt="Mapa del recorrido">
          <img class="map-overlay__frame" src="../game-assets/recorrido/paneles/panel%20mapa.png" alt="">
        </div>
      </div>
      <div class="metadata-overlay" aria-hidden="true">
        <video src="../game-assets/recorrido/paneles/panel%20metadata.webm" playsinline muted loop autoplay></video>
      </div>

      <div class="video-overlay" id="videoOverlay">
        <video id="transition_video" playsinline muted></video>
        <video id="labVideo" playsinline muted></video>
        <!-- Sequence overlay (extracted from RecorridoScene.js)
             Pre-created element so JS can show/pause/hide it. Now centered
             as a square with styles defined in the head <style>. -->
        <div id="sequenceOverlay" aria-hidden="true">
          <video id="sequenceOverlayVideo" src="/game-assets/recorrido/interfaz/loading-text-box-animation.webm" muted playsinline></video>
        </div>
      </div>

      <!-- Efedra wrapper: moved out of #videoOverlay and now lives as a sibling
           inside #hud so it is independent from transition/overlay video state.
           Keeping the same class/id structure preserves existing CSS rules. -->
      <div class="efedra-wrapper" aria-hidden="true" style="display:none;pointer-events:none;">
        <video id="speciesDataVideo" playsinline muted></video>
        <div id="efedra-text-overlay"></div>
      </div>
      <!-- Static transition text overlay (used by RecorridoScene) -->
      <div id="transition-text-overlay" data-static="true" aria-hidden="true">
        <div class="transition-text-inner"></div>
      </div>
      <!-- Zócalo de escena -->
      <video id="zocaloVideo" playsinline muted preload="auto"></video>
    </div>

    <div class="menu-overlay" id="pauseOverlay" aria-hidden="true">
      <div class="menu-overlay__options">
        <button type="button" class="menu-button" data-action="resume">Reanudar</button>
        <button type="button" class="menu-button" data-action="restart">Reiniciar</button>
        <button type="button" class="menu-button" data-action="exit">Volver al laboratorio</button>
      </div>
    </div>

    <div class="menu-overlay menu-overlay--main" id="mainMenuOverlay" aria-hidden="true">
      <div class="menu-overlay__title">Menú Principal</div>
      <div class="menu-overlay__options">
        <button type="button" class="menu-button" data-action="continue">Continuar</button>
        <button type="button" class="menu-button" data-action="new">Comenzar de nuevo</button>
        <button type="button" class="menu-button" data-action="options">Opciones</button>
        <button type="button" class="menu-button" data-action="quit">Salir</button>
      </div>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div id="progress-overlay" class="progress-overlay" aria-hidden="true" style="display: none;">
    <img src="../game-assets/menu/progreso/progreso_empty.png" alt="Progreso del juego" class="progress-bg">
    <div class="progress-bar-mask" data-mask="recorrido" style="clip-path: inset(19.184% 100% 63.144% 0);">
      <img src="../game-assets/menu/progreso/progreso_full.png" alt="" class="progress-full">
    </div>
    <div class="progress-bar-mask" data-mask="subacuatico" style="clip-path: inset(42.024% 100% 40.304% 0);">
      <img src="../game-assets/menu/progreso/progreso_full.png" alt="" class="progress-full">
    </div>
    <div class="progress-bar-mask" data-mask="isla" style="clip-path: inset(64.444% 100% 17.884% 0);">
      <img src="../game-assets/menu/progreso/progreso_full.png" alt="" class="progress-full">
    </div>
    <div class="progress-indicator" data-bar="recorrido" style="top: 28.02%;">
      <span class="progress-percentage">0 %</span>
    </div>
    <div class="progress-indicator" data-bar="subacuatico" style="top: 50.86%;">
      <span class="progress-percentage">0 %</span>
    </div>
    <div class="progress-indicator" data-bar="isla" style="top: 73.28%;">
      <span class="progress-percentage">0 %</span>
    </div>
  </div>

  <script type="module" src="./main.js"></script>
  <!-- efedra wrapper is now a sibling of #videoOverlay (located inside #hud) -->

  <script>
    // Register service worker with automatic version checking and cache busting
    // BUILD_VERSION is injected at build time
    const APP_VERSION = '__BUILD_VERSION__';
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // Check stored version
          const storedVersion = localStorage.getItem('app_version');
          
          if (storedVersion && storedVersion !== APP_VERSION) {
            console.log('[App] Version changed from', storedVersion, 'to', APP_VERSION);
            console.log('[App] Clearing all caches and unregistering service workers...');
            
            // Unregister all service workers
            const registrations = await navigator.serviceWorker.getRegistrations();
            await Promise.all(registrations.map(reg => reg.unregister()));
            
            // Clear all caches
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            
            // Clear localStorage (except settings if needed)
            localStorage.clear();
            sessionStorage.clear();
            
            console.log('[App] All caches cleared. Reloading...');
            localStorage.setItem('app_version', APP_VERSION);
            window.location.reload(true);
            return;
          }
          
          // Store current version
          localStorage.setItem('app_version', APP_VERSION);
          
          // Register service worker with cache-busting query parameter
          const registration = await navigator.serviceWorker.register(
            `/service-worker.js?v=${APP_VERSION}`, 
            { scope: '/' }
          );
          
          console.log('[App] ServiceWorker registered with version:', APP_VERSION);
          
          // Check for updates on every page load
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            console.log('[App] Service worker update found');
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[App] New service worker installed, will activate on next page load');
              }
            });
          });
          
          // Force check for updates
          registration.update();
          
        } catch (err) {
          console.warn('[App] ServiceWorker setup failed:', err);
        }
      });
    }
  </script>

</body>

</html>